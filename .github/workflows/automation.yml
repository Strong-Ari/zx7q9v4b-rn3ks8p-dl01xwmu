name: Automatisation TikTok

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  automate:
    runs-on: ubuntu-latest
    env:
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      CLOUDINARY_AUDIO_FOLDER: music
      METRICOOL_EMAIL: ${{ secrets.METRICOOL_EMAIL }}
      METRICOOL_PASSWORD: ${{ secrets.METRICOOL_PASSWORD }}
      TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      RESEND_TO: ${{ secrets.RESEND_TO }}

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîß Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: üì• Installer pnpm
        run: npm install -g pnpm

      - name: üì¶ Installer les d√©pendances
        run: pnpm install --frozen-lockfile

      # üèÜ CACHE PLAYWRIGHT - Installation une seule fois !
      - name: üíæ Restaurer le cookie Playwright
        uses: actions/cache@v4
        id: cookie-cache
        with:
          path: |
            cookies.json
          key: playwright-cookie-${{ runner.os }}

      - name: üíæ Cache des navigateurs Playwright
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}
          restore-keys: |
            playwright-${{ runner.os }}-

      # Installation conditionnelle - seulement si pas en cache
      - name: üåê Installer les navigateurs Playwright
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps

      - name: üéµ Pr√©-audio
        run: pnpm run preaudio

      - name: üé≠ Pr√©-√©motion
        run: pnpm run preemotion

      - name: üé• Render
        run: pnpm run render

      - name: ‚ú® Postrender - upload sur Cloudinary
        run: pnpm run upload-video-cloudinary

      - name: ‚ú® Postrender - automation vid√©o
        run: pnpm run video-upload-automation

      - name: üì¢ Notifier Telegram (succ√®s ou √©chec)
        if: always()
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ${{ job.status == 'success' && '‚úÖ' || '‚ùå' }} Automatisation TikTok termin√©e !
            Statut: ${{ job.status }}
            Workflow: ${{ github.workflow }}
            Job: ${{ github.job }}
            Commit: ${{ github.sha }}
            Auteur: ${{ github.actor }}
            Lien: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: üìß Envoyer mail stylis√© React Email + Tailwind via Resend
        if: always()
        run: pnpm run send-email
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_TO: ${{ secrets.RESEND_TO }}
          STATUS: ${{ job.status }}
          STATUS_EMOJI: ${{ job.status == 'success' && 'üéâ' || 'üí•' }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}

      - name: üíæ Sauvegarder le cookie Playwright
        uses: actions/cache@v4
        with:
          path: |
            cookies.json
          key: playwright-cookie-${{ runner.os }}
