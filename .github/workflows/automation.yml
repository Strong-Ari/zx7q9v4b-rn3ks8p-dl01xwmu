name: Automatisation TikTok

on:
  schedule:
    # DÃ©clenchement automatique 2x par jour pour optimiser l'engagement USA
    # 18:00 UTC (13:00 EST / 10:00 PST) - Heure de pointe soirÃ©e USA
    # 02:00 UTC (21:00 EST / 18:00 PST) - Heure de pointe soirÃ©e USA (jour suivant)
    - cron: "0 18,2 * * *"
  workflow_dispatch:

jobs:
  automate:
    runs-on: ubuntu-latest
    env:
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      CLOUDINARY_AUDIO_FOLDER: music
      METRICOOL_EMAIL: ${{ secrets.METRICOOL_EMAIL }}
      METRICOOL_PASSWORD: ${{ secrets.METRICOOL_PASSWORD }}
      TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      RESEND_TO: ${{ secrets.RESEND_TO }}

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: ğŸ“¥ Installer pnpm
        run: npm install -g pnpm

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: pnpm install --frozen-lockfile

      - name: GÃ©nÃ©rer LOGIN_HASH
        env:
          METRICOOL_EMAIL: ${{ secrets.METRICOOL_EMAIL }}
          METRICOOL_PASSWORD: ${{ secrets.METRICOOL_PASSWORD }}
        run: |
          LOGIN_HASH=$(npx tsx scripts/generate-login-hash.ts | cut -d '=' -f 2)
          echo "LOGIN_HASH=$LOGIN_HASH" >> $GITHUB_ENV

      - name: ğŸ’¾ Restaurer le cookie Playwright
        uses: actions/cache@v4
        id: cookie-cache
        with:
          path: |
            cookies.json
            cookies.meta.json
          key: playwright-cookie-${{ runner.os }}-${{ env.LOGIN_HASH }}

      # ğŸ† CACHE PLAYWRIGHT - Installation une seule fois !
      - name: ğŸ’¾ Cache des navigateurs Playwright
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}

      # Installation conditionnelle - seulement si pas en cache
      - name: ğŸŒ Installer les navigateurs Playwright
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps

      - name: ğŸµ PrÃ©-audio
        run: pnpm run preaudio

      - name: ğŸ­ PrÃ©-Ã©motion
        run: pnpm run preemotion

      - name: ğŸ¥ Render
        run: pnpm run render
        env:
          # Flags pour consistance de rendu Ubuntu
          CHROMIUM_FLAGS: "--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-gpu --force-device-scale-factor=1 --font-render-hinting=none --disable-font-subpixel-positioning"

      - name: âœ¨ Postrender - upload sur Cloudinary
        run: pnpm run upload-video-cloudinary

      - name: âœ¨ Postrender - automation vidÃ©o
        run: pnpm run video-upload-automation

      - name: ğŸ“¢ Notifier Telegram (succÃ¨s ou Ã©chec)
        if: always()
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} Automatisation TikTok terminÃ©e !
            Statut: ${{ job.status }}
            Workflow: ${{ github.workflow }}
            Job: ${{ github.job }}
            Commit: ${{ github.sha }}
            Auteur: ${{ github.actor }}
            Lien: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: ğŸ“§ Envoyer mail stylisÃ© React Email + Tailwind via Resend
        if: always()
        run: pnpm run send-email
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_TO: ${{ secrets.RESEND_TO }}
          STATUS: ${{ job.status }}
          STATUS_EMOJI: ${{ job.status == 'success' && 'ğŸ‰' || 'ğŸ’¥' }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}

      - name: ğŸ’¾ Sauvegarder le cookie Playwright
        uses: actions/cache@v4
        with:
          path: |
            cookies.json
            cookies.meta.json
          key: playwright-cookie-${{ runner.os }}-${{ env.LOGIN_HASH }}

      - name: ğŸ’¾ Sauvegarder le cache des navigateurs Playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}
